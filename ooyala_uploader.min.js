(function(){var e,f,b,g,d,a=function(h,i){return function(){return h.apply(i,arguments)}},c=[].indexOf||function(k){for(var j=0,h=this.length;j<h;j++){if(j in this&&this[j]===k){return j}}return -1};e=1024*1024*5;d=1000;window.OoyalaUploader=(function(){function h(j){var k,i;if(j==null){j={}}this.uploadFileUsingFlash=a(this.uploadFileUsingFlash,this);this.uploadError=a(this.uploadError,this);this.uploadComplete=a(this.uploadComplete,this);this.uploadProgress=a(this.uploadProgress,this);this.embedCodeReady=a(this.embedCodeReady,this);this.uploadFile=a(this.uploadFile,this);this.off=a(this.off,this);this.on=a(this.on,this);this.chunkProgress={};this.eventListeners={};this.initializeListeners(j);this.uploaderType=(k=j!=null?j.uploaderType:void 0)!=null?k:"HTML5";if((i=this.uploaderType)!=="Flash"&&i!=="HTML5"){throw"uploaderType must be either HTML5 or Flash"}if(this.uploaderType==="Flash"){if((j!=null?j.swfUploader:void 0)==null){throw new Error("a reference to the SWFUpload object is required for Flash uploads")}this.swfUploader=j.swfUploader}}h.prototype.initializeListeners=function(k){var l,m,o,j,n,i;n=["embedCodeReady","uploadProgress","uploadComplete","uploadError"];i=[];for(o=0,j=n.length;o<j;o++){l=n[o];if(k[l]!=null){m=k[l] instanceof Array?k[l]:[k[l]]}else{m=[]}i.push(this.eventListeners[l]=m)}return i};h.prototype.on=function(j,i){if(this.eventListeners[j]==null){throw new Error("invalid eventType")}return this.eventListeners[j].push(i)};h.prototype.off=function(l,j){var k,m,i;if(j==null){j=null}if(j==null){this.eventListeners[l]=[];return}m=this.eventListeners[l];i=[];while((k=m.indexOf(j))>=0){i.push(m.splice(k,1))}return i};h.prototype.uploadFile=function(k,i){var j;if(i==null){i={}}if(!this.html5UploadSupported){return false}j=new g({embedCodeReady:this.embedCodeReady,uploadProgress:this.uploadProgress,uploadComplete:this.uploadComplete,uploadError:this.uploadError,uploaderType:this.uploaderType});j.uploadFile(k,i);return true};h.prototype.embedCodeReady=function(o){var l,n,k,m,i,j;i=(m=this.eventListeners.embedCodeReady)!=null?m:[];j=[];for(n=0,k=i.length;n<k;n++){l=i[n];j.push(l(o))}return j};h.prototype.uploadProgress=function(l,o){var i,q,m,p,n,k,j;q=this.chunkProgress[l];if(o===q){return}this.chunkProgress[l]=o;k=(n=this.eventListeners.uploadProgress)!=null?n:[];j=[];for(m=0,p=k.length;m<p;m++){i=k[m];j.push(i(l,o))}return j};h.prototype.uploadComplete=function(o){var l,n,k,m,i,j;delete this.chunkProgress[o];i=(m=this.eventListeners.uploadComplete)!=null?m:[];j=[];for(n=0,k=i.length;n<k;n++){l=i[n];j.push(l(o))}return j};h.prototype.uploadError=function(m,q,l,p,s){var i,n,r,o,k,j;k=(o=this.eventListeners.uploadError)!=null?o:[];j=[];for(n=0,r=k.length;n<r;n++){i=k[n];j.push(i(m,q,l,p,s))}return j};h.prototype.uploadFileUsingFlash=function(i){var j;if(i==null){i={}}if(this.uploaderType!=="Flash"){throw new Error("uploaderType must be Flash to call this method")}j=new g({embedCodeReady:this.embedCodeReady,uploadProgress:this.uploadProgress,uploadComplete:this.uploadComplete,uploadError:this.uploadError,uploaderType:this.uploaderType,swfUploader:this.swfUploader});j.uploadFileUsingFlash(i);return true};h.prototype.html5UploadSupported=typeof FileReader!=="undefined"&&FileReader!==null;return h})();g=(function(){function h(j){this.onError=a(this.onError,this);this.onAssetUploadComplete=a(this.onAssetUploadComplete,this);this.onChunkComplete=a(this.onChunkComplete,this);this.onChunkProgress=a(this.onChunkProgress,this);this.onFlashUploadError=a(this.onFlashUploadError,this);this.onFlashUploadComplete=a(this.onFlashUploadComplete,this);this.onFlashUploadProgress=a(this.onFlashUploadProgress,this);this.startFlashUpload=a(this.startFlashUpload,this);this.startHTML5Upload=a(this.startHTML5Upload,this);this.onUploadUrlsReceived=a(this.onUploadUrlsReceived,this);this.onAssetCreated=a(this.onAssetCreated,this);this.createAsset=a(this.createAsset,this);this.setAssetMetadata=a(this.setAssetMetadata,this);this.uploadFileUsingFlash=a(this.uploadFileUsingFlash,this);this.uploadFile=a(this.uploadFile,this);var k,i,n,m,l;this.embedCodeReadyCallback=(k=j!=null?j.embedCodeReady:void 0)!=null?k:function(){};this.uploadProgressCallback=(i=j!=null?j.uploadProgress:void 0)!=null?i:function(){};this.uploadCompleteCallback=(n=j!=null?j.uploadComplete:void 0)!=null?n:function(){};this.uploadErrorCallback=(m=j!=null?j.uploadError:void 0)!=null?m:function(){};this.uploaderType=(l=j!=null?j.uploaderType:void 0)!=null?l:"HTML5";if(this.uploaderType==="Flash"){this.swfUploader=j.swfUploader}this.chunkUploaders={};this.completedChunkIndexes=[];this.completedChunks=0;this.totalChunks}h.prototype.uploadFile=function(j,i){var k,l;this.file=j;console.log("Uploading file using browser: "+navigator.userAgent);this.setAssetMetadata(i);if((l=(k=this.assetMetadata).assetName)==null){k.assetName=this.file.name}this.assetMetadata.fileSize=this.file.size;this.assetMetadata.fileName=this.file.name;return this.createAsset()};h.prototype.uploadFileUsingFlash=function(i){var j,k,l;j=this.swfUploader.getFile(0);if(j==null){throw new Error("Flash Upload: No Files Queued")}this.setAssetMetadata(i);if((l=(k=this.assetMetadata).assetName)==null){k.assetName=j.name}this.assetMetadata.fileSize=j.size;this.assetMetadata.fileName=j.name;this.swfUploader.settings.upload_success_handler=this.onFlashUploadSuccess;this.swfUploader.settings.upload_progress_handler=this.onFlashUploadProgress;this.swfUploader.settings.upload_error_handler=this.onFlashUploadError;return this.createAsset()};h.prototype.setAssetMetadata=function(r){var q,p,o,n,m,l,k,j,i;return this.assetMetadata={assetCreationUrl:(q=r.assetCreationUrl)!=null?q:"/v2/assets",assetUploadingUrl:(p=r.assetUploadingUrl)!=null?p:"/v2/assets/assetID/uploading_urls",assetStatusUpdateUrl:(o=r.assetStatusUpdateUrl)!=null?o:"/v2/assets/assetID/upload_status",assetName:r.name,assetDescription:(n=r.description)!=null?n:"",assetType:(m=r.assetType)!=null?m:"video",createdAt:new Date().getTime(),assetLabels:(l=r.labels)!=null?l:[],postProcessingStatus:(k=r.postProcessingStatus)!=null?k:"live",labelCreationUrl:(j=r.labelCreationUrl)!=null?j:"/v2/labels/by_full_path/paths",labelAssignmentUrl:(i=r.labelAssignmentUrl)!=null?i:"/v2/assets/assetID/labels",assetID:""}};h.prototype.createAsset=function(){var i,j=this;i={name:this.assetMetadata.assetName,description:this.assetMetadata.assetDescription,file_name:this.assetMetadata.fileName,file_size:this.assetMetadata.fileSize,asset_type:this.assetMetadata.assetType,post_processing_status:this.assetMetadata.postProcessingStatus};if(this.uploaderType==="HTML5"){i.chunk_size=e}return jQuery.ajax({url:this.assetMetadata.assetCreationUrl,type:"POST",data:i,success:function(k){return j.onAssetCreated(k)},error:function(k){return j.onError(k,"Asset creation error")}})};h.prototype.onAssetCreated=function(i){var j;j=JSON.parse(i);this.assetMetadata.assetID=j.embed_code;this.embedCodeReadyCallback(this.assetMetadata.assetID);this.assetMetadata.assetLabels.filter(function(k){return k});if(this.assetMetadata.assetLabels.length!==0){this.createLabels()}return this.getUploadingUrls()};h.prototype.createLabels=function(){var i,j=this;i=this.assetMetadata.assetLabels.join(",");return jQuery.ajax({url:this.assetMetadata.labelCreationUrl.replace("paths",i),type:"POST",success:function(k){return j.assignLabels(k)},error:function(k){return j.onError(k,"Label creation error")}})};h.prototype.assignLabels=function(m){var j,i,k,l=this;k=JSON.parse(m);i=(function(){var p,o,n;n=[];for(p=0,o=k.length;p<o;p++){j=k[p];n.push(j.id)}return n})();return jQuery.ajax({url:this.assetMetadata.labelAssignmentUrl.replace("assetID",this.assetMetadata.assetID),type:"POST",data:JSON.stringify(i),success:function(n){return l.onLabelsAssigned(n)},error:function(n){return l.onError(n,"Label assignment error")}})};h.prototype.onLabelsAssigned=function(i){return console.log("Creation and assignment of labels complete "+this.assetMetadata.assetLabels)};h.prototype.getUploadingUrls=function(){var i=this;return jQuery.ajax({url:this.assetMetadata.assetUploadingUrl.split("assetID").join(this.assetMetadata.assetID),data:{asset_id:this.assetMetadata.assetID},success:function(j){return i.onUploadUrlsReceived(j)},error:function(j){return i.onError(j,"Error getting the uploading urls")}})};h.prototype.onUploadUrlsReceived=function(j){var i;i=JSON.parse(j);this.totalChunks=i.length;if(this.uploaderType==="HTML5"){return this.startHTML5Upload(i)}else{return this.startFlashUpload(i)}};h.prototype.startHTML5Upload=function(i){var k,j=this;k=new b(this.file,e).getChunks();if(k.length!==this.totalChunks){console.log("Sliced chunks ("+k.length+") and uploadingUrls ("+this.totalChunks+") disagree.")}return jQuery.each(k,function(n,m){var l;if(c.call(j.completedChunkIndexes,n)>=0){return}l=new f({assetMetadata:j.assetMetadata,chunkIndex:n,chunk:m,uploadUrl:i[n],progress:j.onChunkProgress,completed:j.onChunkComplete,error:j.uploadErrorCallback});j.chunkUploaders[n]=l;return l.startUpload()})};h.prototype.startFlashUpload=function(i){this.swfUploader.setUploadURL(i[0]);return this.swfUploader.startUpload()};h.prototype.onFlashUploadProgress=function(i,k,j){var l;l=Math.floor((k*100)/j);l=Math.min(100,l);return this.uploadProgressCallback(this.assetMetadata.assetID,l)};h.prototype.onFlashUploadComplete=function(j,i,k){return this.onAssetUploadComplete()};h.prototype.onFlashUploadError=function(j,k,i){return this.uploadErrorCallback({assetID:this.assetMetadata.assetID,type:this.assetMetadata.assetType,fileName:this.assetMetadata.assetName,statusCode:k,message:i})};h.prototype.progressPercent=function(){var m,k,j,i,n,l;k=0;l=this.chunkUploaders;for(j in l){i=l[j];k+=i.bytesUploaded}m=(this.completedChunks*e)+k;n=Math.floor((m*100)/this.assetMetadata.fileSize);return Math.min(100,n)};h.prototype.onChunkProgress=function(){return this.uploadProgressCallback(this.assetMetadata.assetID,this.progressPercent())};h.prototype.onChunkComplete=function(j,i){this.completedChunks++;this.completedChunkIndexes.push(i);delete this.chunkUploaders[i];this.onChunkProgress();if(this.completedChunks===this.totalChunks){return this.onAssetUploadComplete()}};h.prototype.onAssetUploadComplete=function(){var i=this;return jQuery.ajax({url:this.assetMetadata.assetStatusUpdateUrl.split("assetID").join(this.assetMetadata.assetID),data:{asset_id:this.assetMetadata.assetID,status:"uploaded"},type:"PUT",success:function(j){return i.uploadCompleteCallback(i.assetMetadata.assetID)},error:function(j){return i.onError(j,"Setting asset status as uploaded error")}})};h.prototype.onError=function(i,m){var k,l;try{l=JSON.parse(i.responseText);k=l.message}catch(j){k=i.statusText}console.log(""+this.assetMetadata.assetName+": "+m+" with status "+i.status+": "+k);return this.uploadErrorCallback({assetID:this.assetMetadata.assetID,type:this.assetMetadata.assetType,fileName:this.assetMetadata.assetName,statusCode:i.status,message:""+m+", "+k})};return h})();f=(function(){function h(i){this.onXhrError=a(this.onXhrError,this);this.onXhrLoad=a(this.onXhrLoad,this);this.startUpload=a(this.startUpload,this);this.assetMetadata=i.assetMetadata;this.chunk=i.chunk;this.chunkIndex=i.chunkIndex;this.progressHandler=i.progress;this.completedHandler=i.completed;this.uploadErrorCallback=i.error;this.uploadUrl=i.uploadUrl;this.bytesUploaded=0}h.prototype.startUpload=function(){var i=this;console.log(""+this.assetMetadata.assetID+": Starting upload of chunk "+this.chunkIndex);this.xhr=new XMLHttpRequest();this.xhr.upload.addEventListener("progress",function(j){i.bytesUploaded=j.loaded;return i.progressHandler()});this.xhr.addEventListener("load",this.onXhrLoad);this.xhr.addEventListener("error",this.onXhrError);this.xhr.open("PUT",this.uploadUrl);return this.xhr.send(this.chunk)};h.prototype.onXhrLoad=function(j){var i;i=j.target.status;if(i>=400){return onXhrError(j)}else{this.bytesUploaded=e;return this.completedHandler(j,this.chunkIndex)}};h.prototype.onXhrError=function(j){var i;i=j.target.status;console.log(""+this.assetMetadata.assetID+": chunk "+this.chunkIndex+": Xhr Error Status "+i);return this.uploadErrorCallback({assetID:this.assetMetadata.assetID,type:this.assetMetadata.assetType,fileName:this.assetMetadata.assetName,statusCode:j.status,message:j.responseText})};return h})();b=(function(){function h(i,j){this.file=i;this.chunkSize=j}h.prototype.getChunks=function(){var k,m,l,j;if(!(this.file.slice||this.file.mozSlice)){return[this.file]}j=[];for(k=m=0,l=Math.ceil(this.file.size/this.chunkSize);0<=l?m<l:m>l;k=0<=l?++m:--m){j.push(this.slice(k*this.chunkSize,(k+1)*this.chunkSize))}return j};h.prototype.slice=function(j,i){if(this.file.slice){return this.file.slice(j,i)}else{if(this.file.mozSlice){return this.file.mozSlice(j,i)}}};return h})()}).call(this);